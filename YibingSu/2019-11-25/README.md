# 缓存穿透、缓存击穿、缓存雪崩区别和解决方案

>作者：敖丙
>来自：[掘金](https://juejin.im/post/5dbef8306fb9a0203f6fa3e2)
## 一、缓存处理流程
前台请求，后台先从缓存中取数据，取到直接返回结果，取不到时从数据库中取，数据库取到更新缓存，并返回结果，数据库也没取到，那直接返回空结果。
 ![picture](https://ftp.bmp.ovh/imgs/2019/11/5f496c7018049454.png)

 ## 二丶缓存雪崩

 ### 描述
 缓存雪崩是指缓存中数据**大批量**到过期时间，而查询数据量巨大，**引起数据库压力过大甚至down机**。

 **举个简单的例子**：目前电商首页以及热点数据都会去做缓存 ，一般缓存都是定时任务去刷新，或者是查不到之后去更新的，定时任务刷新就有一个问，如果所有首页的Key失效时间都是12小时，中午12点刷新的，我零点有个秒杀活动大量用户涌入，假设当时每秒 6000 个请求，本来缓存在可以扛住每秒 5000 个请求，但是缓存当时所有的Key都失效了。此时 1 秒 6000 个请求全部落数据库，数据库必然扛不住，它会报一下警，真实情况可能DBA都没反应过来就直接挂了。

 ![picture](https://ftp.bmp.ovh/imgs/2019/11/89913b4613f5ddeb.jpg)

 ### 解决方案
 1.在批量往reids存数据的时候，每个key设置随机的失效时间。
 2.设置热点数据永不过期，有更新数据同时更新缓存。
 3.如果redis是集群部署，将热点数据均匀分布在不同的redis库中也能避免全部失效的问题。

 ## 三丶缓存穿透

 ### 描述
 缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求，我们数据库的 id 都是1开始自增上去的，如发起为id为“-1”的数据或id为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大，严重会击垮数据库。

### 解决方案
1.在接口层增加校验，不合法的参数直接return。
2.从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击

## 四丶缓存击穿

### 描述
缓存击穿和缓存雪崩有的相似，缓存雪崩是大面积的缓存失效，打崩数据库，而缓存击穿是指**一个key非常热点**，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个Key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库。

### 解决方案
1.设置热点数据永远不过期。
2.加互斥锁。
![picture](https://ftp.bmp.ovh/imgs/2019/11/d9406720b469d1e0.png)